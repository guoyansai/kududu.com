import{d as l,b as a,I as e,J as t,r as s,j as o,o as d,k as n,l as i,N as u,E as r,F as c,s as b,w as v,u as m,q as p,c as f}from"./chunk-asai-BcUlmSst.js";import{_ as y}from"./entry-asai-C1GKnLJc.js";import"./chunk-asai-Dt9XmewB.js";import"./chunk-asai-BEbmHGt4.js";const k={class:"ro-modbus"},V={class:"ro-modbus-table"},C={class:"ro-modbus-tr_header"},_={class:"form"},h={class:"form-item"},g={class:"form"},j={class:"form-item"},w={class:"form"},T={class:"form-item"},A={class:"form"},I={class:"form-item"},D={class:"form"},M={class:"form-item"},O={key:0,class:"state-y"},U={key:1,class:"state-n"},N={class:"operate"},R={key:0,class:"ro-modbus-tr_content"},x={class:"table-header"},W={class:"form-btn"},E={class:"form-data"},S={class:"form-data-val"},$={class:"form-data-val"},F={class:"form",style:{width:"100%"}},q={class:"form-item"},H={class:"form"},J={class:"form-item"},P={key:0,class:"form"},z={class:"form-item"},B={class:"form"},G={class:"form-item"},K={class:"table-content"},L={class:"table-tr"},Q={key:0,class:"table-tr_th table-tr_check"},X={key:0,class:"table-tr_td table-tr_check"},Y={class:"table-tr_td"},Z={class:"table-tr_td table-tr_td_alias_w"},ll={key:0,class:"alias-input"},al={class:"alias-input-edit"},el=["onClick"],tl={key:1,class:"table-tr_td table-tr_td_val table-tr_td_val_w"},sl={class:"val-input"},ol=["onClick"],dl={key:2,class:"table-tr_td"},nl=y(l({__name:"RobotModbus",props:{ujt:{}},setup(l){const y=l,{$fn:nl}=y.ujt;let il=a({tableData:[],endianOptions:[{label:"大端",value:1},{label:"小端",value:2}],functionCodeOptions:[{label:"01 Read Coils(0x)",value:1},{label:"02 Read Discrete Inputs(1x)",value:2},{label:"03 Read Holding Registers(4x)",value:3},{label:"04 Read Input Registers(3x)",value:4},{label:"05 Write Single Coil",value:5},{label:"06 Write Single Register",value:6},{label:"15 Write Multiple Coils",value:15},{label:"16 Write Multiple Registers",value:16}],writeArr:[5,6,15,16],registers:[3,4,6,16],readArr:[1,2,3,4],aliasCur:null,aliasVal:"",aliasOldVal:"",typeOptions:[{label:"16进制有符号",value:"I16"},{label:"16进制无符号",value:"U16"},{label:"32进制有符号",value:"I32"},{label:"32进制无符号",value:"U32"},{label:"64进制有符号",value:"I64"},{label:"64进制无符号",value:"U64"},{label:"32位浮点数",value:"F32"},{label:"64位浮点数",value:"F64"}]}),ul=null,rl=null;function cl(l="",a=5){let e=Math.random().toString(36).substr(3,a);return l?`${l}${e}`:e}function bl(){il.tableData.push({name:cl("device",3),slaveId:1,ip:"192.168.1.1",port:502,endian:1})}function vl(l,a,e,t){ul&&clearTimeout(ul),ul=setTimeout((()=>{"count"===t&&(a.tables[e].val=new Array(l).fill(0)),a.tables[e][t]=l}),500)}function ml(l,a,e){var t;let s="";if(null==(t=l.tables[a])?void 0:t.alias)for(let o of Object.keys(l.tables[a].alias))if(l.tables[a].alias[o]===l.tables[a].addr+e){s=o;break}return s}function pl(){nl.ws.cocontrol.wsApi({ty:"ModbusTcp/getState",db:{}}).then((l=>{console.log(l,"ModbusTcp/getState"),il.tableData.forEach(((a,e)=>{var t,s,o,d;if(null==l?void 0:l.db[a.name]){void 0!==(null==(t=null==l?void 0:l.db[a.name])?void 0:t.state)&&(il.tableData[e].state=null==l?void 0:l.db[a.name].state);let n=null==(s=null==l?void 0:l.db[a.name])?void 0:s.tables;if(n)for(let l of Object.keys(n))il.tableData[e].tables[l].syncCount=n[l].syncCount||0,il.tableData[e].tables[l].syncError=n[l].syncError||0,(null==(o=n[l])?void 0:o.val)&&(il.tableData[e].tables[l].val=null==(d=n[l])?void 0:d.val)}}))}))}function fl(){rl&&clearInterval(rl),rl=null}return nl.ws.cocontrol.wsApi({ty:"ModbusTcp/getConfig",db:""}).then((l=>{il.tableData=Object.keys(l.db).map((a=>{let e=l.db[a];if(e.tables)for(let l of Object.keys(e.tables))e.tables[l].checkAddr=[];return{name:a,...e}})),pl(),rl=setInterval((()=>{pl()}),2e3)})),e((()=>il.tableData),(l=>{(null==l?void 0:l.length)||fl()}),{immediate:!0,deep:!0}),t((()=>{fl()})),(l,a)=>{const e=s("el-button"),t=s("el-input"),y=s("el-select"),rl=s("el-dropdown"),pl=s("CustomInputNumber"),fl=s("el-checkbox");return d(),o("div",k,[n(e,{type:"primary",onClick:bl},{default:u((()=>a[1]||(a[1]=[r(" 新增设备 ")]))),_:1}),i("div",V,[(d(!0),o(c,null,b(m(il).tableData,((s,k)=>(d(),o("div",{class:"ro-modbus-tr",key:"modbus_"+k},[i("div",C,[i("div",_,[a[2]||(a[2]=i("div",{class:"form-label"}," 从站id： ",-1)),i("div",h,[n(t,{modelValue:s.slaveId,"onUpdate:modelValue":l=>s.slaveId=l},null,8,["modelValue","onUpdate:modelValue"])])]),i("div",g,[a[3]||(a[3]=i("div",{class:"form-label"}," IP地址： ",-1)),i("div",j,[n(t,{modelValue:s.ip,"onUpdate:modelValue":l=>s.ip=l},null,8,["modelValue","onUpdate:modelValue"])])]),i("div",w,[a[4]||(a[4]=i("div",{class:"form-label"}," 端口号： ",-1)),i("div",T,[n(t,{modelValue:s.port,"onUpdate:modelValue":l=>s.port=l},null,8,["modelValue","onUpdate:modelValue"])])]),i("div",A,[a[5]||(a[5]=i("div",{class:"form-label"}," 模式： ",-1)),i("div",I,[n(y,{modelValue:s.endian,"onUpdate:modelValue":l=>s.endian=l,options:m(il).endianOptions,ujt:l.ujt},null,8,["modelValue","onUpdate:modelValue","options","ujt"])])]),i("div",D,[a[6]||(a[6]=i("div",{class:"form-label"}," 连接状态： ",-1)),i("div",M,[(null==s?void 0:s.state)?(d(),o("span",O," 已连接 ")):(d(),o("span",U," 未连接 "))])]),i("div",N,[n(e,{type:"primary",onClick:l=>function(l,a){var e;(null==(e=il.tableData[a])?void 0:e.tables)||(il.tableData[a].tables={}),il.tableData[a].tables[cl("table",3)]={functionCode:1,addr:0,count:1,period:1e3,checkAddr:[]}}(0,k)},{default:u((()=>a[7]||(a[7]=[r(" 新增表 ")]))),_:2},1032,["onClick"]),n(e,{type:"primary",onClick:l=>function(l){let a={name:l.name,slaveId:l.slaveId,ip:l.ip,port:l.port,endian:l.endian};nl.ws.cocontrol.wsApi({ty:"ModbusTcp/setDevice",db:a}).then((l=>{}))}(s)},{default:u((()=>a[8]||(a[8]=[r(" 保存 ")]))),_:2},1032,["onClick"]),n(e,{type:"danger",onClick:l=>function(l,a){nl.ws.cocontrol.wsApi({ty:"ModbusTcp/removeDevice",db:{name:l.name}}).then((l=>{il.tableData.splice(a,1)}))}(s,k)},{default:u((()=>a[9]||(a[9]=[r(" 删除 ")]))),_:2},1032,["onClick"])])]),s.tables&&Object.keys(s.tables).length?(d(),o("div",R,[(d(!0),o(c,null,b(Object.keys(s.tables),((V,C)=>{var _,h,g;return d(),o("div",{class:"table",key:"table_"+C},[i("div",x,[i("div",W,[n(e,{type:"primary",onClick:l=>function(l,a){let e={name:l.name,tableName:a,functionCode:l.tables[a].functionCode,addr:l.tables[a].addr,count:l.tables[a].count,period:l.tables[a].period};console.log(e,"ModbusTcp/setTable"),nl.ws.cocontrol.wsApi({ty:"ModbusTcp/setTable",db:e}).then((l=>{}))}(s,V)},{default:u((()=>a[10]||(a[10]=[r(" 保存表 ")]))),_:2},1032,["onClick"]),n(e,{type:"danger",onClick:l=>function(l,a,e){let t={name:l.name,tableName:a};console.log(t,"ModbusTcp/removeTable"),nl.ws.cocontrol.wsApi({ty:"ModbusTcp/removeTable",db:t}).then((l=>{delete il.tableData[e].tables[a]}))}(s,V,k)},{default:u((()=>a[11]||(a[11]=[r(" 删除 ")]))),_:2},1032,["onClick"]),a[13]||(a[13]=r("    ")),n(rl,{disabled:!(null==(_=s.tables[V])?void 0:_.checkAddr.length),options:m(il).typeOptions,ujt:l.ujt,onChange:l=>function(l,a,e){let t=a.tables[e].checkAddr.sort(),s=t[t.length-1]-t[0],o={name:a.name,tableName:e,type:l,addr:t[0],count:s+1};console.log(o,"ModbusTcp/setType"),nl.ws.cocontrol.wsApi({ty:"ModbusTcp/setType",db:o}).then((l=>{}))}(l,s,V)},{default:u((()=>[n(e,{type:"primary"},{default:u((()=>a[12]||(a[12]=[r(" 设置数据类型 ")]))),_:1})])),_:2},1032,["disabled","options","ujt","onChange"])]),i("div",E,[i("div",S," 同步次数："+p((null==(h=s.tables[V])?void 0:h.syncCount)||0),1),i("div",$," 同步错误次数："+p((null==(g=s.tables[V])?void 0:g.syncError)||0),1)]),i("div",F,[a[14]||(a[14]=i("div",{class:"form-label"}," 功能码： ",-1)),i("div",q,[n(y,{modelValue:s.tables[V].functionCode,"onUpdate:modelValue":l=>s.tables[V].functionCode=l,options:m(il).functionCodeOptions,ujt:l.ujt,onChange:l=>function(l,a,e){a.tables[e].addr=0,a.tables[e].count=1,a.tables[e].val=[0],a.tables[e].checkAddr=[]}(0,s,V)},null,8,["modelValue","onUpdate:modelValue","options","ujt","onChange"])])]),i("div",H,[a[15]||(a[15]=i("div",{class:"form-label"}," 起始地址： ",-1)),i("div",J,[n(t,{value:s.tables[V].addr,type:"number",onInput:l=>vl(l,s,V,"addr")},null,8,["value","onInput"])])]),[5,6].includes(s.tables[V].functionCode)?v("",!0):(d(),o("div",P,[a[16]||(a[16]=i("div",{class:"form-label"}," 读写数量： ",-1)),i("div",z,[n(t,{value:s.tables[V].count,type:"number",onInput:l=>vl(l,s,V,"count")},null,8,["value","onInput"])])])),i("div",B,[a[17]||(a[17]=i("div",{class:"form-label"}," 同步周期： ",-1)),i("div",G,[n(pl,{modelValue:s.tables[V].period,"onUpdate:modelValue":l=>s.tables[V].period=l,ujt:l.ujt},null,8,["modelValue","onUpdate:modelValue","ujt"])])])]),i("div",K,[i("div",L,[m(il).registers.includes(s.tables[V].functionCode)?(d(),o("div",Q)):v("",!0),a[18]||(a[18]=i("div",{class:"table-tr_th"}," 地址 ",-1)),a[19]||(a[19]=i("div",{class:"table-tr_th table-tr_td_alias_w"}," 别名 ",-1)),a[20]||(a[20]=i("div",{class:"table-tr_th table-tr_td_val_w"}," 值 ",-1))]),(d(!0),o(c,null,b(s.tables[V].count,((b,y)=>{var C;return d(),o("div",{class:"table-tr",key:"count_"+y},[m(il).registers.includes(s.tables[V].functionCode)?(d(),o("div",X,[n(fl,{value:s.tables[V].checkAddr.includes(s.tables[V].addr+y),onChange:l=>function(l,a,e,t){let s=a.tables[e].addr+t;if(a.tables[e].checkAddr.includes(s)){let l=a.tables[e].checkAddr.indexOf(s);a.tables[e].checkAddr.splice(l,1)}else a.tables[e].checkAddr.push(s)}(0,s,V,y)},null,8,["value","onChange"])])):v("",!0),i("div",Y,p(s.tables[V].addr+y),1),i("div",Z,[V+"_"+(s.tables[V].addr+y)===m(il).aliasCur?(d(),o("div",ll,[i("div",al,[n(t,{modelValue:m(il).aliasVal,"onUpdate:modelValue":a[0]||(a[0]=l=>m(il).aliasVal=l)},null,8,["modelValue"])]),n(e,{type:"primary",onClick:l=>function(l,a,e,t){if(!il.aliasVal)return void(il.aliasCur=null);if(il.aliasVal===il.aliasOldVal)return void(il.aliasCur=null);il.tableData[t].tables[a].alias||(il.tableData[t].tables[a].alias={});let s={name:l.name,tableName:a,addr:l.tables[a].addr+e,alias:il.aliasVal};console.log(s,"ModbusTcp/setName"),nl.ws.cocontrol.wsApi({ty:"ModbusTcp/setName",db:s}).then((t=>{l.tables[a].alias[il.aliasVal]=l.tables[a].addr+e,il.aliasOldVal&&delete l.tables[a].alias[il.aliasOldVal],il.aliasCur=null,il.aliasVal="",il.aliasOldVal=""}))}(s,V,y,k)},{default:u((()=>a[21]||(a[21]=[r(" 保存 ")]))),_:2},1032,["onClick"])])):(d(),o("div",{key:1,class:"alias-text",onClick:l=>function(l,a,e,t){il.aliasVal=t,il.aliasOldVal=t,il.aliasCur=`${a}_${l.tables[a].addr+e}`}(s,V,y,ml(s,V,y))},p(ml(s,V,y)),9,el))]),(null==(C=s.tables[V])?void 0:C.val)?(d(),o("div",tl,[i("div",sl,[m(il).writeArr.includes(s.tables[V].functionCode)?(d(),o(c,{key:0},[s.tables[V].isWrite===y?(d(),f(pl,{key:0,modelValue:s.tables[V].curVal,"onUpdate:modelValue":l=>s.tables[V].curVal=l,ujt:l.ujt,onInput:l=>function(l,a,e,t){""!==l&&(ul&&clearTimeout(ul),ul=setTimeout((()=>{let l={name:a.name,tableName:e,addr:a.tables[e].addr+t,val:a.tables[e].curVal};console.log(l,"ModbusTcp/setVal"),nl.ws.cocontrol.wsApi({ty:"ModbusTcp/setVal",db:l}).then((l=>{a.tables[e].val[t]=a.tables[e].curVal,a.tables[e].isWrite=null}))}),1e3))}(l,s,V,y)},null,8,["modelValue","onUpdate:modelValue","ujt","onInput"])):(d(),o("div",{key:1,class:"write-val",onClick:l=>function(l,a,e){"-"!==l.tables[a].val[e]&&(l.tables[a].curVal=l.tables[a].val[e],l.tables[a].isWrite=e)}(s,V,y)},p(s.tables[V].val[y]),9,ol))],64)):(d(),o(c,{key:1},[r(p(s.tables[V].val[y]),1)],64))])])):(d(),o("div",dl," 0 "))])})),128))])])})),128))])):v("",!0)])))),128))])])}}}),[["__scopeId","data-v-3adf48d7"]]),il=l({__name:"default",props:{ujt:{}},setup:l=>(l,a)=>(d(),f(nl,{ujt:l.ujt},null,8,["ujt"]))});export{il as default};
